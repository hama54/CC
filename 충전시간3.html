<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배터리 충전 정보</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" data-bs-theme="dark">
    <style>
        .error {
            font-size: 0.8em;
            margin-top: 0.25rem;
        }
        .input-group {
            flex-wrap: nowrap;
        }
        .input-group .form-control {
            min-width: 70px;
            flex: 1 1 auto;
        }
        .input-group .input-group-text {
            white-space: nowrap;
        }
        @media (max-width: 576px) {
             /* Small screen adjustments if needed */
        }

        /* Style for read-only fields displaying calculated results */
        .form-control[readonly] {
            background-color: var(--bs-secondary-bg); /* Slightly lighter background in dark theme */
            opacity: 1; /* Ensure text is fully visible */
        }
    </style>
</head>
<body>
    <div class="container py-4">
        <div class="mb-4">
            <h1>배터리 충전 정보</h1>
        </div>

        <div class="mb-3">
            <label for="batteryCapacity" class="form-label">배터리 용량 :</label>
            <div class="input-group">
                <input type="number" class="form-control" id="batteryCapacity" min="0" step="0.01" value="84" oninput="updateAll()">
                <span class="input-group-text">kWh</span>
            </div>
            <div id="batteryCapacityError" class="error text-danger"></div>
        </div>

        <div class="mb-3">
            <label for="remainPercent" class="form-label">남은 용량 :</label>
            <div class="input-group">
                <input type="number" class="form-control" id="remainPercent" min="0" max="100" step="0.01" oninput="updateRemainFromPercent()">
                <span class="input-group-text">%</span>
                <input type="number" class="form-control" id="remainKWh" min="0" step="0.01" oninput="updateRemainFromKWh()">
                <span class="input-group-text">kWh</span>
            </div>
            <div id="remainError" class="error text-danger"></div>
        </div>

        <div class="mb-3">
            <label for="targetPercent" class="form-label">충전 목표 용량 :</label>
            <div class="input-group">
                <input type="number" class="form-control" id="targetPercent" min="0" max="100" step="0.01" oninput="updateTargetFromPercent()">
                <span class="input-group-text">%</span>
                <input type="number" class="form-control" id="targetKWh" min="0" step="0.01" oninput="updateTargetFromKWh()">
                <span class="input-group-text">kWh</span>
            </div>
            <div id="targetError" class="error text-danger"></div>
        </div>

        <div class="mb-3">
            <label for="chargeSpeed" class="form-label">충전 속도 :</label>
            <div class="input-group">
                <input type="number" class="form-control" id="chargeSpeed" min="0" step="0.01" oninput="updateTime()">
                <span class="input-group-text">kW</span>
            </div>
            <div id="chargeSpeedError" class="error text-danger"></div>
        </div>

        <div class="mb-3">
            <label for="estimatedTime" class="form-label">충전 소요 시간 :</label>
            <input type="text" class="form-control" id="estimatedTime" readonly>
        </div>

        <div class="mb-3">
            <label for="startTime" class="form-label">충전 시작 시간 :</label>
            <input type="time" class="form-control" id="startTime" oninput="updateTime()">
             <div id="startTimeError" class="error text-danger"></div>
        </div>

        <div class="mb-3">
            <label for="endTime" class="form-label">충전 완료 시간 :</label>
            <input type="text" class="form-control" id="endTime" readonly>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Input Element References
        const batteryCapacityInput = document.getElementById("batteryCapacity");
        const remainPercentInput = document.getElementById("remainPercent");
        const remainKWhInput = document.getElementById("remainKWh");
        const targetPercentInput = document.getElementById("targetPercent");
        const targetKWhInput = document.getElementById("targetKWh");
        const chargeSpeedInput = document.getElementById("chargeSpeed");
        const startTimeInput = document.getElementById("startTime");
        const estimatedTimeInput = document.getElementById("estimatedTime");
        const endTimeInput = document.getElementById("endTime");

        // Error Message Element References
        const batteryCapacityError = document.getElementById("batteryCapacityError");
        const remainError = document.getElementById("remainError");
        const targetError = document.getElementById("targetError");
        const chargeSpeedError = document.getElementById("chargeSpeedError");
        const startTimeError = document.getElementById("startTimeError");

        let isUpdating = false;

        // --- Validation Function (Revised Focus) ---
        function validateInputs() {
            let isValid = true; // Assume valid initially
            // Clear previous errors
            batteryCapacityError.innerText = "";
            remainError.innerText = "";
            targetError.innerText = "";
            chargeSpeedError.innerText = "";
            startTimeError.innerText = ""; // Clear start time error

            // Parse input values
            const capacity = parseFloat(batteryCapacityInput.value);
            const remainPercent = parseFloat(remainPercentInput.value);
            const remainKWh = parseFloat(remainKWhInput.value);
            const targetPercent = parseFloat(targetPercentInput.value);
            const targetKWh = parseFloat(targetKWhInput.value);
            const speed = parseFloat(chargeSpeedInput.value);

            // --- Validate Individual Input Fields for Errors ---

            // Validate Battery Capacity (Must be valid positive number)
            if (batteryCapacityInput.value && (isNaN(capacity) || capacity <= 0)) {
                batteryCapacityError.innerText = "배터리 용량을 0보다 큰 숫자로 입력해주세요.";
                isValid = false; // Essential, calculation depends on it
            }

            // Validate Remaining Capacity (Show errors for invalid formats/ranges)
            if (remainKWhInput.value && (isNaN(remainKWh) || remainKWh < 0 || (!isNaN(capacity) && remainKWh > capacity))) {
                 remainError.innerText = "남은 용량(kWh)을 0과 배터리 용량 사이의 숫자로 입력해주세요.";
            } else if (remainPercentInput.value && (isNaN(remainPercent) || remainPercent < 0 || remainPercent > 100)) {
                 remainError.innerText = "남은 용량(%)을 0과 100 사이의 숫자로 입력해주세요.";
            } else if (remainKWhInput.value || remainPercentInput.value) {
                 remainError.innerText = ""; // Clear if individual inputs seem ok or empty
            }

            // Validate Target Capacity (Show errors for invalid formats/ranges)
             if (targetKWhInput.value && (isNaN(targetKWh) || targetKWh < 0 || (!isNaN(capacity) && targetKWh > capacity))) {
                 targetError.innerText = "목표 용량(kWh)을 0과 배터리 용량 사이의 숫자로 입력해주세요.";
             } else if (targetPercentInput.value && (isNaN(targetPercent) || targetPercent < 0 || targetPercent > 100)) {
                 targetError.innerText = "목표 용량(%)을 0과 100 사이의 숫자로 입력해주세요.";
             } else if (targetKWhInput.value || targetPercentInput.value) {
                 targetError.innerText = ""; // Clear if individual inputs seem ok or empty
             }

             // Add the target > remain check error message here for clarity
             if (!isNaN(remainKWh) && !isNaN(targetKWh) && remainKWh >= targetKWh) {
                 targetError.innerText = "충전 목표 용량은 남은 용량보다 커야 합니다.";
             }

            // Validate Charge Speed (Must be valid positive number for calculation)
            if (chargeSpeedInput.value && (isNaN(speed) || speed <= 0)) {
                chargeSpeedError.innerText = "충전 속도를 0보다 큰 숫자로 입력해주세요.";
                isValid = false; // Essential for calculation
            }

            return isValid;
        }


        // --- Helper Function ---
        function getBatteryCapacity() {
            return parseFloat(batteryCapacityInput.value) || 0;
        }

        // --- Update Functions for Remaining/Target Capacity ---
        function updateRemainFromPercent() {
            if (isUpdating) return;
            isUpdating = true;
            const cap = getBatteryCapacity();
            const percent = parseFloat(remainPercentInput.value);
            remainKWhInput.value = !isNaN(percent) && cap > 0 ? (Math.round((cap * percent / 100) * 100) / 100).toFixed(2) : '';
            updateTime();
            isUpdating = false;
        }

        function updateRemainFromKWh() {
            if (isUpdating) return;
            isUpdating = true;
            const cap = getBatteryCapacity();
            const kwh = parseFloat(remainKWhInput.value);
            remainPercentInput.value = (!isNaN(kwh) && cap > 0) ? (Math.round((kwh / cap * 100) * 100) / 100).toFixed(2) : '';
            updateTime();
            isUpdating = false;
        }

        function updateTargetFromPercent() {
            if (isUpdating) return;
            isUpdating = true;
            const cap = getBatteryCapacity();
            const percent = parseFloat(targetPercentInput.value);
            targetKWhInput.value = !isNaN(percent) && cap > 0 ? (Math.round((cap * percent / 100) * 100) / 100).toFixed(2) : '';
            updateTime();
            isUpdating = false;
        }

        function updateTargetFromKWh() {
            if (isUpdating) return;
            isUpdating = true;
            const cap = getBatteryCapacity();
            const kwh = parseFloat(targetKWhInput.value);
            targetPercentInput.value = (!isNaN(kwh) && cap > 0) ? (Math.round((kwh / cap * 100) * 100) / 100).toFixed(2) : '';
            updateTime();
            isUpdating = false;
        }

        // --- Update Time Calculation (Duration and End Time) ---
        function updateTime() {
            estimatedTimeInput.value = '';
            endTimeInput.value = '';
            startTimeError.innerText = ""; // Clear previous start time errors/messages

            if (!validateInputs()) { // Check basic validity (capacity, speed format)
                return;
            }

            const target = parseFloat(targetKWhInput.value);
            const remain = parseFloat(remainKWhInput.value);
            const speed = parseFloat(chargeSpeedInput.value);
            const startTimeValue = startTimeInput.value;

            // Check if we have enough valid numbers to calculate duration
            if (isNaN(target) || isNaN(remain) || isNaN(speed) || speed <= 0 || target <= remain) {
                return; // Stop calculation if prerequisites not met
            }

            // --- Proceed with Calculation ---
            const neededEnergy = target - remain;
            const timeInHours = neededEnergy / speed;
            const totalMinutesDuration = Math.round(timeInHours * 60);

            if (totalMinutesDuration >= 0) {
                // Format duration
                const hours = Math.floor(totalMinutesDuration / 60);
                const minutes = totalMinutesDuration % 60;
                estimatedTimeInput.value = hours > 0 ? `${hours}시간 ${minutes}분` : `${minutes}분`;

                // Calculate and format end time if start time is provided
                if (startTimeValue) {
                    try {
                        const [startHour, startMinute] = startTimeValue.split(':').map(Number);

                        if (!isNaN(startHour) && !isNaN(startMinute)) {
                            const startDate = new Date();
                            startDate.setHours(startHour, startMinute, 0, 0);
                            const endDate = new Date(startDate.getTime() + totalMinutesDuration * 60 * 1000);

                            // Format end time as "HH:MM" (Based on user's last provided code)
                            const endHour = endDate.getHours().toString().padStart(2, '0');
                            const endMinute = endDate.getMinutes().toString().padStart(2, '0');
                            endTimeInput.value = `${endHour}:${endMinute}`;
                        } else {
                            startTimeError.innerText = "유효한 시작 시간을 입력해주세요.";
                            endTimeInput.value = '';
                        }
                    } catch (e) {
                        console.error("Error parsing/calculating end time:", e);
                        startTimeError.innerText = "완료 시간 계산 중 오류 발생.";
                        endTimeInput.value = '';
                    }
                } else {
                    endTimeInput.value = '';
                    startTimeError.innerText = "시작 시간을 선택하면 완료 시간이 계산됩니다.";
                }

            } else {
                estimatedTimeInput.value = '0분';
                // If duration is 0, end time is the same as start time
                if (startTimeValue && totalMinutesDuration === 0) {
                   try {
                       const [startHour, startMinute] = startTimeValue.split(':').map(Number);
                       if(!isNaN(startHour) && !isNaN(startMinute)) {
                           // Format consistently with the main path
                           endTimeInput.value = `${String(startHour).padStart(2,'0')}:${String(startMinute).padStart(2,'0')}`;
                       } else { endTimeInput.value = ''; }
                   } catch { endTimeInput.value = ''; }
                } else {
                    endTimeInput.value = '';
                }
            }
        }


        // --- Update All Function (when capacity changes) ---
        function updateAll() {
            isUpdating = true;
            const cap = getBatteryCapacity();

            const remainPercent = parseFloat(remainPercentInput.value);
            if (!isNaN(remainPercent) && cap > 0) {
                 remainKWhInput.value = (Math.round((cap * remainPercent / 100) * 100) / 100).toFixed(2);
            } else if (!remainPercentInput.value) {
                 remainKWhInput.value = '';
            }

            const targetPercent = parseFloat(targetPercentInput.value);
            if (!isNaN(targetPercent) && cap > 0) {
                 targetKWhInput.value = (Math.round((cap * targetPercent / 100) * 100) / 100).toFixed(2);
            } else if (!targetPercentInput.value) {
                 targetKWhInput.value = '';
            }

            isUpdating = false;
            updateTime();
        }

        // --- Set Default Start Time and Initial Calculation on Load ---
         window.onload = () => {
            // Get current time
            const now = new Date();
            // Ensure correct formatting (HH:MM) for time input value
            const currentHour = now.getHours().toString().padStart(2, '0');
            const currentMinute = now.getMinutes().toString().padStart(2, '0');

            // Set the start time input value only if it's currently empty
            if (!startTimeInput.value) {
               startTimeInput.value = `${currentHour}:${currentMinute}`;
            }

            // Trigger initial calculation based on default values
            updateTime();
         };
    </script>
</body>
</html>