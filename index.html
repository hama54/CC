<!DOCTYPE html>
<html lang="ko" data-bs-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>배터리 충전 정보 계산기</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" data-bs-theme="dark">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <style>
        /* --- 기본 및 컨테이너 --- */
        body { font-size: 0.95rem; }
        /* 기본 py-2, lg 이상 py-3 */
        /* .container { padding-top: 1.5rem; padding-bottom: 1.5rem; } */

        /* --- 텍스트 및 에러 --- */
        .error { font-size: 0.75em; margin-top: 0.2rem; min-height: 0.9em; display: block; color: var(--bs-danger-text-emphasis); }

        /* --- 입력 그룹 --- */
        .input-group-sm .form-control-sm { min-width: 55px; }
        .input-group-sm > .input-group-text {
             font-size: 0.8em;
             padding: 0.25rem 0.4rem;
         }
        .input-group .input-group-text { white-space: nowrap; }
        .equals-separator { display: flex; align-items: center; justify-content: center; color: var(--bs-secondary-color); font-weight: bold; padding: 0 0.25rem; height: 100%; }

        /* --- 결과 섹션 (기본 큰 화면 기준) --- */
        .result-section {
            padding: 1.5rem !important; /* p-3 */
            margin-bottom: 1.5rem !important; /* mb-4 */
         }
        .result-section .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; } /* mb-3 */
        .result-item { padding: 0.5rem 0.5rem; } /* py-2 px-2 */
        .result-header { font-size: 0.8rem; color: var(--bs-secondary-color); margin-bottom: 0.25rem; font-weight: 500; display: flex; align-items: center; justify-content: center; white-space: nowrap; line-height: 1.1; }
        .result-value { min-height: 1.8rem; display: flex; align-items: center; justify-content: center; word-break: keep-all; overflow-wrap: break-word; font-size: 1.15rem; font-weight: 500; color: var(--bs-body-color); }

        /* --- 프로그레스 바 (기본 큰 화면 기준) --- */
        .progress { height: 1rem; margin-top: 1rem; background-color: var(--bs-secondary-bg); font-size: 0.7em; } /* mt-3 */
        .progress-bar { transition: width 0.3s ease-in-out; }

        /* --- 카드 (기본 큰 화면 기준) --- */
        .card { margin-bottom: 1.5rem !important; } /* mb-4 */
        .card .card-header { padding: 0.5rem 1rem; font-size: 0.95rem; display: flex; justify-content: space-between; align-items: center; } /* py-2 px-3 */
        .card .card-header h6 { margin-bottom: 0; }
        .card .card-body { padding: 1.5rem; } /* p-3 */

        /* --- 폼 요소 --- */
        .form-label { margin-bottom: 0.25rem; font-size: 0.85em; font-weight: 500; display: block; white-space: nowrap; } /* mb-1 */
        /* 카드 내부 mb 기본은 mb-2, lg 이상 mb-3 */
        /* .card .card-body .mb-lg-3 { margin-bottom: 1rem !important; } */

        /* --- 유틸리티 --- */
        .no-wrap-row { flex-wrap: nowrap !important; }
        .no-wrap-row > [class*="col"] { flex-shrink: 0; }
        #effectiveSpeedOutput:disabled { background-color: var(--bs-tertiary-bg); border-style: dashed; opacity: 0.8; cursor: not-allowed; font-weight: 500; }
        #saveFeedback { display: inline-block; margin-left: 0.5rem; font-size: 0.8em; opacity: 0; transition: opacity 0.5s ease-in-out; }
        #saveFeedback.show { opacity: 1; }

        /* --- 푸터 (기본 큰 화면 기준) --- */
        footer { font-size: 0.8em; margin-top: 2rem; padding-top: 1rem; } /* mt-4, pt-3 */
        footer a { text-decoration: underline; }

        /* --- 모바일 화면 (lg 미만) 간격 줄이기 --- */
        @media (max-width: 991.98px) {
            .result-section {
                padding: 0.75rem !important; /* p-2 */
                margin-bottom: 1rem !important; /* mb-3 */
            }
            .result-section .header { margin-bottom: 0.5rem; } /* mb-2 */
            .result-item { padding-top: 0.25rem; padding-bottom: 0.25rem; } /* py-1 */
            .progress { margin-top: 0.75rem; } /* mt-2 와 비슷 */

            .card { margin-bottom: 1rem !important; } /* mb-3 */
            .card .card-header { padding-top: 0.25rem; padding-bottom: 0.25rem; } /* py-1 */
            .card .card-body { padding: 0.75rem; } /* p-2 */

            footer { margin-top: 1.5rem; padding-top: 0.75rem; } /* mt-3, pt-2 와 비슷 */
        }
    </style>
</head>
<body>
    <div class="container py-2 py-lg-3">
        <div class="mb-3 mb-lg-4 text-center">
            <h1 style="font-size: 1.8rem;"><i class="bi bi-ev-station-fill me-2"></i>배터리 충전 정보</h1>
        </div>

        <div class="border rounded shadow-sm bg-body-tertiary result-section">
            <div class="header">
                <h5 style="font-size: 1rem; margin-bottom: 0;">
                    <i class="bi bi-check-circle-fill me-2 text-success"></i>예상 결과
                </h5>
                <div>
                    <button class="btn btn-outline-secondary btn-sm me-2" id="calculateBtn"><i class="bi bi-calculator me-1"></i> 계산</button>
                    <button class="btn btn-outline-secondary btn-sm" id="resetBtn"><i class="bi bi-arrow-counterclockwise me-1"></i> 초기화</button>
                </div>
            </div>
            <div class="row text-center result-grid g-2 no-wrap-row">
                <div class="col result-item">
                    <div class="result-header"><i class="bi bi-hourglass-split me-1"></i> 소요시간</div>
                    <div class="result-value" id="estimatedTime">-</div>
                </div>
                <div class="col result-item border-start border-end">
                    <div class="result-header"><i class="bi bi-calendar-check me-1"></i> 완료시간</div>
                    <div class="result-value" id="endTime">-</div>
                </div>
                <div class="col result-item">
                    <div class="result-header"><i class="bi bi-clock-history me-1"></i> 남은시간</div>
                    <div class="result-value" id="remainingUntilEndTime">-</div>
                </div>
            </div>
            <div class="progress" role="progressbar" aria-label="현재 배터리 충전 상태" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
                <div class="progress-bar bg-success overflow-visible text-dark fw-bold" id="chargeProgress" style="width: 0%;">
                    <span id="progressText" class="visually-hidden">0%</span>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <h6><i class="bi bi-battery-half me-2"></i>배터리 정보</h6>
                <button class="btn btn-sm btn-outline-secondary" id="saveBatteryInfoBtn" aria-label="배터리 정보 저장">저장</button>
            </div>
            <div class="card-body">
                <div class="mb-2 mb-lg-3">
                    <label for="batteryCapacity" class="form-label">배터리 총 용량 :</label>
                    <div class="input-group input-group-sm">
                        <input type="number" class="form-control form-control-sm" id="batteryCapacity" min="0" step="0.01" required aria-label="배터리 총 용량 (kWh)" aria-describedby="batteryCapacityError">
                        <span class="input-group-text">kWh</span>
                    </div>
                    <div id="batteryCapacityError" class="error text-danger" aria-live="polite"></div>
                </div>
                <div class="mb-2 mb-lg-3">
                    <label class="form-label">현재 배터리 :</label>
                    <div class="row g-1 align-items-center no-wrap-row">
                        <div class="col"><div class="input-group input-group-sm"><input type="number" class="form-control form-control-sm" id="remainPercent" min="0" max="100" step="0.01" required aria-label="현재 배터리 (%)" aria-describedby="remainError"><span class="input-group-text">%</span></div></div>
                        <div class="col-auto px-1"><span class="equals-separator">=</span></div>
                        <div class="col"><div class="input-group input-group-sm"><input type="number" class="form-control form-control-sm" id="remainKWh" min="0" step="0.01" required aria-label="현재 배터리 (kWh)" aria-describedby="remainError"><span class="input-group-text">kWh</span></div></div>
                    </div>
                    <div id="remainError" class="error text-danger" aria-live="polite"></div>
                </div>
                <div class="mb-0">
                    <label class="form-label">충전 목표 :</label>
                    <div class="row g-1 align-items-center no-wrap-row">
                        <div class="col"><div class="input-group input-group-sm"><input type="number" class="form-control form-control-sm" id="targetPercent" min="0" max="100" step="0.01" required aria-label="충전 목표 (%)" aria-describedby="targetError"><span class="input-group-text">%</span></div></div>
                        <div class="col-auto px-1"><span class="equals-separator">=</span></div>
                        <div class="col"><div class="input-group input-group-sm"><input type="number" class="form-control form-control-sm" id="targetKWh" min="0" step="0.01" required aria-label="충전 목표 (kWh)" aria-describedby="targetError"><span class="input-group-text">kWh</span></div></div>
                    </div>
                    <div id="targetError" class="error text-danger" aria-live="polite"></div>
                </div>
            </div>
        </div>

        <div class="card shadow-sm">
            <div class="card-header">
                <h6><i class="bi bi-speedometer2 me-2"></i>충전 설정</h6>
                <button class="btn btn-sm btn-outline-secondary" id="saveChargeSettingsBtn" aria-label="충전 설정 저장">저장</button>
            </div>
            <div class="card-body">
                <div class="row g-2 mb-2 mb-lg-3 align-items-center no-wrap-row speed-efficiency-row">
                    <div class="col">
                        <label for="chargeSpeed" class="form-label">충전 속도 :</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control form-control-sm" id="chargeSpeed" min="0" step="0.01" required aria-label="충전 속도 (kW)" aria-describedby="chargeSpeedError">
                            <span class="input-group-text">kW</span>
                        </div>
                        <div id="chargeSpeedError" class="error text-danger" aria-live="polite"></div>
                    </div>
                    <div class="col">
                        <label for="efficiency" class="form-label">충전 효율 (%) :</label>
                        <div class="input-group input-group-sm">
                            <input type="number" class="form-control form-control-sm" id="efficiency" min="1" max="100" step="0.1" required aria-label="충전 효율 (%)" aria-describedby="efficiencyError">
                            <span class="input-group-text">%</span>
                        </div>
                        <div id="efficiencyError" class="error text-danger" aria-live="polite"></div>
                    </div>
                    <div class="col-auto px-1">
                        <span class="equals-separator">=</span>
                    </div>
                    <div class="col">
                        <label class="form-label">실제 속도:</label>
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control form-control-sm" id="effectiveSpeedOutput" readonly disabled aria-label="실제 충전 속도 (kW)">
                            <span class="input-group-text">kW</span>
                        </div>
                        <div class="error"></div>
                    </div>
                </div>
                <div class="mb-0">
                    <div class="input-group input-group-sm">
                        <label for="startTime" class="input-group-text">충전 시작 시간 :</label>
                        <input type="time" class="form-control form-control-sm" id="startTime" required aria-label="충전 시작 시간" aria-describedby="startTimeError">
                        <button class="btn btn-sm btn-outline-secondary" type="button" id="applyCurrentTimeBtn" aria-label="현재 시간 적용">
                            <i class="bi bi-clock-history me-1"></i> 현재 시간
                        </button>
                    </div>
                    <div id="startTimeError" class="error text-body-secondary" aria-live="polite"></div>
                </div>
            </div>
        </div>

        <div class="text-center">
            <span id="saveFeedback"></span>
        </div>
    </div>

    <footer class="container text-center text-muted border-top">
        <p><small>
            Copyright © 2025 오휴성
            <br>
            이 저작물은 <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">크리에이티브 커먼즈 저작자표시-비영리-변경금지 4.0 국제 라이선스</a>에 따라 이용할 수 있습니다.
            <br>
            <a rel="license" href="http://creativecommons.org/licenses/by-nc-nd/4.0/" target="_blank">
                <img alt="크리에이티브 커먼즈 라이선스" style="border-width:0; margin-top: 0.5rem;" src="https://i.creativecommons.org/l/by-nc-nd/4.0/88x31.png" />
            </a>
        </small></p>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- 상수 정의 ---
        const DEFAULT_CAPACITY = "84";
        const DEFAULT_EFFICIENCY = "90";
        const LS_BATTERY_KEY = 'batteryCalculator_batteryInfo';
        const LS_SETTINGS_KEY = 'batteryCalculator_chargeSettings';
        const DEBOUNCE_DELAY = 300; // ms

        // --- DOM 요소 ---
        const elements = {
            batteryCapacity: document.getElementById("batteryCapacity"),
            remainPercent: document.getElementById("remainPercent"),
            remainKWh: document.getElementById("remainKWh"),
            targetPercent: document.getElementById("targetPercent"),
            targetKWh: document.getElementById("targetKWh"),
            chargeSpeed: document.getElementById("chargeSpeed"),
            efficiency: document.getElementById("efficiency"),
            effectiveSpeedOutput: document.getElementById("effectiveSpeedOutput"),
            startTime: document.getElementById("startTime"),
            applyCurrentTimeBtn: document.getElementById("applyCurrentTimeBtn"),
            estimatedTime: document.getElementById("estimatedTime"),
            endTime: document.getElementById("endTime"),
            remainingUntilEndTime: document.getElementById("remainingUntilEndTime"),
            chargeProgress: document.getElementById("chargeProgress"),
            progressText: document.getElementById("progressText"),
            batteryCapacityError: document.getElementById("batteryCapacityError"),
            remainError: document.getElementById("remainError"),
            targetError: document.getElementById("targetError"),
            chargeSpeedError: document.getElementById("chargeSpeedError"),
            efficiencyError: document.getElementById("efficiencyError"),
            startTimeError: document.getElementById("startTimeError"),
            calculateBtn: document.getElementById("calculateBtn"),
            resetBtn: document.getElementById("resetBtn"),
            saveBatteryInfoBtn: document.getElementById("saveBatteryInfoBtn"),
            saveChargeSettingsBtn: document.getElementById("saveChargeSettingsBtn"),
            saveFeedback: document.getElementById("saveFeedback")
        };

        // --- 상태 변수 ---
        let isUpdating = false; // % <=> kWh 변환 시 무한 루프 방지 플래그
        let countdownIntervalId = null; // 남은 시간 업데이트 인터벌 ID (setTimeout or requestAnimationFrame)
        let calculatedEndDate = null; // 계산된 종료 시간 Date 객체
        let feedbackTimeoutId = null; // 피드백 메시지 자동 숨김 타이머 ID

        // --- 유틸리티 함수 ---
        function debounce(fn, ms) {
            let timeoutId;
            return function(...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => fn.apply(this, args), ms);
            };
        }

        function clamp(value, min, max) {
            return Math.min(Math.max(value, min), max);
        }

        function getBatteryCapacity() {
            const capacity = parseFloat(elements.batteryCapacity.value);
            return (!isNaN(capacity) && capacity > 0) ? capacity : 0;
        }

        function percentToKWh(percent) {
            const cap = getBatteryCapacity();
            return (!isNaN(percent) && percent >= 0 && percent <= 100 && cap > 0) ? (cap * percent / 100).toFixed(2) : '';
        }

        function kWhToPercent(kwh) {
            const cap = getBatteryCapacity();
            return (!isNaN(kwh) && kwh >= 0 && cap > 0 && kwh <= cap) ? (kwh / cap * 100).toFixed(2) : '';
        }

        // --- 입력 유효성 검사 ---
        function validateInputs() {
            let isValid = true;
            // 모든 에러 메시지 초기화
            Object.keys(elements).forEach(key => {
                if (key.endsWith("Error")) {
                    elements[key].innerText = "";
                    // 시작 시간 에러는 기본 상태로 (text-body-secondary)
                    if (key === "startTimeError") {
                        elements[key].classList.remove("text-danger");
                        elements[key].classList.add("text-body-secondary");
                    }
                }
            });

            const capacity = parseFloat(elements.batteryCapacity.value);
            const remainKWh = parseFloat(elements.remainKWh.value);
            const targetKWh = parseFloat(elements.targetKWh.value);
            const speed = parseFloat(elements.chargeSpeed.value);
            const efficiency = parseFloat(elements.efficiency.value);
            const remainPercent = parseFloat(elements.remainPercent.value);
            const targetPercent = parseFloat(elements.targetPercent.value);

            // 개별 입력 필드 유효성 검사
            if (elements.batteryCapacity.value && (isNaN(capacity) || capacity <= 0)) {
                elements.batteryCapacityError.innerText = "용량은 0보다 커야 합니다."; isValid = false;
            }
            if (elements.chargeSpeed.value && (isNaN(speed) || speed <= 0)) {
                elements.chargeSpeedError.innerText = "속도는 0보다 커야 합니다."; isValid = false;
            }
            if (elements.efficiency.value && (isNaN(efficiency) || efficiency < 1 || efficiency > 100)) {
                elements.efficiencyError.innerText = "효율은 1 ~ 100% 사이여야 합니다."; isValid = false;
            }
            if (elements.remainKWh.value && (isNaN(remainKWh) || remainKWh < 0 || (capacity > 0 && remainKWh > capacity))) {
                elements.remainError.innerText = `0 ~ ${capacity || '?'} kWh 범위 내여야 합니다.`; isValid = false;
            } else if (elements.remainPercent.value && (isNaN(remainPercent) || remainPercent < 0 || remainPercent > 100)) {
                elements.remainError.innerText = "0 ~ 100% 범위 내여야 합니다."; isValid = false;
            }
            if (elements.targetKWh.value && (isNaN(targetKWh) || targetKWh < 0 || (capacity > 0 && targetKWh > capacity))) {
                elements.targetError.innerText = `0 ~ ${capacity || '?'} kWh 범위 내여야 합니다.`; isValid = false;
            } else if (elements.targetPercent.value && (isNaN(targetPercent) || targetPercent < 0 || targetPercent > 100)) {
                elements.targetError.innerText = "0 ~ 100% 범위 내여야 합니다."; isValid = false;
            }

            // 목표값 vs 현재값 비교 (둘 다 유효한 숫자일 때만)
            if (!isNaN(remainKWh) && !isNaN(targetKWh) && remainKWh >= targetKWh && (elements.remainKWh.value || elements.targetKWh.value)) {
                 if (!elements.targetError.innerText) elements.targetError.innerText = "목표 용량이 현재 용량보다 커야 합니다.";
                 isValid = false;
            }


            return isValid;
        }

        // --- UI 업데이트 함수 ---
        function updateProgress() {
            let currentPercent = 0;
            const capacity = getBatteryCapacity();
            if (elements.remainPercent.value && !isNaN(parseFloat(elements.remainPercent.value))) {
                currentPercent = parseFloat(elements.remainPercent.value);
            } else if (elements.remainKWh.value && !isNaN(parseFloat(elements.remainKWh.value)) && capacity > 0) {
                currentPercent = (parseFloat(elements.remainKWh.value) / capacity * 100);
            }
            currentPercent = clamp(currentPercent, 0, 100); // 0~100% 범위 보장
            const progressRounded = currentPercent.toFixed(1);

            elements.chargeProgress.style.width = `${progressRounded}%`;
            elements.chargeProgress.setAttribute('aria-valuenow', progressRounded);

            if(currentPercent > 15) {
                elements.chargeProgress.textContent = `${progressRounded}%`;
                elements.progressText.classList.add('visually-hidden');
                elements.progressText.textContent = "";
            } else {
                elements.chargeProgress.textContent = "";
                 elements.progressText.classList.remove('visually-hidden');
                elements.progressText.textContent = `${progressRounded}%`;
            }
        }

        function updateEffectiveSpeed() {
            const speed = parseFloat(elements.chargeSpeed.value);
            const efficiencyPercent = parseFloat(elements.efficiency.value);
            let effectiveSpeedText = "-";
            let effectiveSpeed = 0;
            if (!isNaN(speed) && speed > 0 && !isNaN(efficiencyPercent) && efficiencyPercent >= 1 && efficiencyPercent <= 100) {
                effectiveSpeed = speed * (efficiencyPercent / 100);
                effectiveSpeedText = effectiveSpeed.toFixed(2);
            }
            elements.effectiveSpeedOutput.value = effectiveSpeedText;
            return effectiveSpeed;
        }

        function showSaveFeedback(message, type = "success") { // type: success, info, danger, warning
            clearTimeout(feedbackTimeoutId);
            elements.saveFeedback.textContent = message;
            elements.saveFeedback.className = 'ms-2 fs-sm'; // 기본 클래스
            elements.saveFeedback.classList.add(`text-${type}`); // 타입별 클래스 추가
            elements.saveFeedback.classList.add('show'); // 표시

            feedbackTimeoutId = setTimeout(() => {
                elements.saveFeedback.classList.remove('show'); // 2초 후 숨김
            }, 2000);
        }

        // --- 계산 관련 함수 ---
        function calculateChargingDuration(neededEnergy, effectiveSpeed) {
            if (neededEnergy <= 0 || effectiveSpeed <= 0) {
                return 0;
            }
            const timeInHours = neededEnergy / effectiveSpeed;
            return Math.ceil(timeInHours * 60);
        }

        function formatDuration(totalMinutesDuration) {
            if (totalMinutesDuration <= 0) return '0분';
            const hours = Math.floor(totalMinutesDuration / 60);
            const minutes = totalMinutesDuration % 60;
            return hours > 0 ? `${hours}시간 ${minutes}분` : `${minutes}분`;
        }

        function calculateEndTime(startTimeValue, totalMinutesDuration) {
            if (!startTimeValue || totalMinutesDuration < 0) return null;
            try {
                const [startHour, startMinute] = startTimeValue.split(':').map(Number);
                if (isNaN(startHour) || isNaN(startMinute) || startHour < 0 || startHour > 23 || startMinute < 0 || startMinute > 59) {
                    throw new Error("Invalid time format");
                }
                const startDate = new Date();
                startDate.setHours(startHour, startMinute, 0, 0);
                return new Date(startDate.getTime() + totalMinutesDuration * 60 * 1000);
            } catch (e) {
                console.error("Error parsing start time or calculating end date:", e);
                elements.startTimeError.innerText = "잘못된 시간 형식입니다.";
                elements.startTimeError.classList.add("text-danger");
                elements.startTimeError.classList.remove("text-body-secondary");
                return null;
            }
        }

        function formatEndTime(endDate) {
            if (!endDate) return '-';
            const options = { hour: '2-digit', minute: '2-digit', hour12: true };
            let endTimeString = endDate.toLocaleTimeString('ko-KR', options);

            const today = new Date(); today.setHours(0,0,0,0);
            const endDay = new Date(endDate); endDay.setHours(0,0,0,0);
            const todayTimestamp = today.getTime();
            const endDayTimestamp = endDay.getTime();
            const daysDiff = Math.round((endDayTimestamp - todayTimestamp) / (1000 * 60 * 60 * 24));

            if (daysDiff > 0) {
                const daysOfWeek = ["일", "월", "화", "수", "목", "금", "토"];
                endTimeString += ` (+${daysDiff}일, ${daysOfWeek[endDate.getDay()]})`;
            } else if (daysDiff < 0) {
                 endTimeString += ` (${Math.abs(daysDiff)}일 전)`;
            }
            return endTimeString;
        }

        function updateResultUI(durationString, endTimeString, endDate) {
            elements.estimatedTime.textContent = durationString;
            elements.endTime.textContent = endTimeString;
            calculatedEndDate = endDate;

            if (endDate && !elements.startTimeError.classList.contains('text-danger')) {
                 elements.startTimeError.innerText = "";
            } else if (!elements.startTime.value && durationString !== '-' && durationString !== '0분') {
                 elements.startTimeError.innerText = "시작 시간 입력 시 완료 시간 계산";
                 elements.startTimeError.classList.remove("text-danger");
                 elements.startTimeError.classList.add("text-body-secondary");
            } else if (!elements.startTime.value) {
                 elements.startTimeError.innerText = "";
            }

            startOrStopCountdown(endDate);
        }

        // --- 카운트다운 함수 ---
        function updateCountdown() {
            if (countdownIntervalId) { cancelAnimationFrame(countdownIntervalId); clearTimeout(countdownIntervalId); countdownIntervalId = null; }

            if (!calculatedEndDate || isNaN(calculatedEndDate.getTime())) {
                elements.remainingUntilEndTime.textContent = '-';
                return;
            }

            const now = new Date();
            const diffMs = calculatedEndDate.getTime() - now.getTime();

            if (diffMs <= 0) {
                elements.remainingUntilEndTime.textContent = '완료됨';
                return;
            }

            const totalSeconds = Math.ceil(diffMs / 1000);
            const days = Math.floor(totalSeconds / (3600 * 24));
            const hours = Math.floor((totalSeconds % (3600 * 24)) / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            let display = [];
            if (days > 0) display.push(`${days}일`);
            if (hours > 0 || days > 0) display.push(`${hours}시간`);
            if (minutes > 0 || hours > 0 || days > 0) display.push(`${minutes}분`);
            if (days === 0 && hours === 0 && minutes === 0) display.push(`${seconds}초`);

            elements.remainingUntilEndTime.textContent = display.join(' ') || '곧 완료';

            if (totalSeconds <= 60) {
                countdownIntervalId = requestAnimationFrame(updateCountdown);
            } else {
                const secondsToNextMinute = seconds === 0 ? 60 : seconds;
                const timeoutMs = secondsToNextMinute * 1000 + 10;
                countdownIntervalId = setTimeout(updateCountdown, timeoutMs);
            }
        }

        function startOrStopCountdown(endDate) {
             if (countdownIntervalId) { cancelAnimationFrame(countdownIntervalId); clearTimeout(countdownIntervalId); countdownIntervalId = null; }

            if (endDate && endDate.getTime() > Date.now()) {
                updateCountdown();
            } else {
                elements.remainingUntilEndTime.textContent = (endDate && endDate.getTime() <= Date.now()) ? '완료됨' : '-';
            }
        }


        // --- 메인 계산 로직 ---
        function calculateAndUpdateResults() {
            elements.estimatedTime.textContent = '-';
            elements.endTime.textContent = '-';
            elements.remainingUntilEndTime.textContent = '-';
            calculatedEndDate = null;
            startOrStopCountdown(null);

            const effectiveSpeed = updateEffectiveSpeed();
            updateProgress();

            if (!validateInputs()) {
                return;
            }

            const targetKWhVal = parseFloat(elements.targetKWh.value);
            const remainKWhVal = parseFloat(elements.remainKWh.value);
            const startTimeValue = elements.startTime.value;

            if (isNaN(targetKWhVal) || isNaN(remainKWhVal) || effectiveSpeed <= 0 || targetKWhVal <= remainKWhVal) {
                updateResultUI('-', '-', null);
                return;
            }

            const neededEnergy = targetKWhVal - remainKWhVal;
            const totalMinutesDuration = calculateChargingDuration(neededEnergy, effectiveSpeed);
            const durationString = formatDuration(totalMinutesDuration);

            let finalEndDate = null;
            let endTimeString = '-';
            if (startTimeValue) {
                finalEndDate = calculateEndTime(startTimeValue, totalMinutesDuration);
                endTimeString = formatEndTime(finalEndDate);
            }

            updateResultUI(durationString, endTimeString, finalEndDate);
        }

        const calculateAndUpdateResultsDebounced = debounce(calculateAndUpdateResults, DEBOUNCE_DELAY);

        // --- % <=> kWh 연동 핸들러 ---
        function updateLinkedValue(sourceInput, targetInput, calculateFunc) {
            if (isUpdating) return;
            isUpdating = true;

            const sourceValue = parseFloat(sourceInput.value);
            targetInput.value = calculateFunc(sourceValue);
            calculateAndUpdateResultsDebounced();

            isUpdating = false;
        }
        function handleRemainPercentChange() { updateLinkedValue(elements.remainPercent, elements.remainKWh, percentToKWh); }
        function handleRemainKWhChange() { updateLinkedValue(elements.remainKWh, elements.remainPercent, kWhToPercent); }
        function handleTargetPercentChange() { updateLinkedValue(elements.targetPercent, elements.targetKWh, percentToKWh); }
        function handleTargetKWhChange() { updateLinkedValue(elements.targetKWh, elements.targetPercent, kWhToPercent); }

        // --- 데이터 저장/로드 ---
        function saveBatteryInfo() {
            const data = {
                capacity: elements.batteryCapacity.value,
                remainPercent: elements.remainPercent.value,
                targetPercent: elements.targetPercent.value
            };
            try {
                localStorage.setItem(LS_BATTERY_KEY, JSON.stringify(data));
                showSaveFeedback("배터리 정보 저장됨", "success");
            } catch (e) {
                console.error("로컬 스토리지 저장 오류 (배터리 정보):", e);
                showSaveFeedback("배터리 정보 저장 실패", "danger");
            }
        }

        function saveChargeSettings() {
            const data = {
                speed: elements.chargeSpeed.value,
                efficiency: elements.efficiency.value
            };
            try {
                localStorage.setItem(LS_SETTINGS_KEY, JSON.stringify(data));
                showSaveFeedback("충전 설정 저장됨", "success");
            } catch (e) {
                console.error("로컬 스토리지 저장 오류 (충전 설정):", e);
                showSaveFeedback("충전 설정 저장 실패", "danger");
            }
        }

        function loadSettings() {
            try {
                const batteryDataString = localStorage.getItem(LS_BATTERY_KEY);
                if (batteryDataString) {
                    const data = JSON.parse(batteryDataString);
                    elements.batteryCapacity.value = data.capacity || DEFAULT_CAPACITY;
                    elements.remainPercent.value = data.remainPercent || "";
                    elements.targetPercent.value = data.targetPercent || "";
                } else {
                    elements.batteryCapacity.value = DEFAULT_CAPACITY;
                }

                const settingsDataString = localStorage.getItem(LS_SETTINGS_KEY);
                if (settingsDataString) {
                    const data = JSON.parse(settingsDataString);
                    elements.chargeSpeed.value = data.speed || "";
                    elements.efficiency.value = data.efficiency || DEFAULT_EFFICIENCY;
                } else {
                     elements.efficiency.value = DEFAULT_EFFICIENCY;
                }

                 updateAllLinkedValues();
                 calculateAndUpdateResults();

            } catch (e) {
                console.error("로컬 스토리지 로드 오류:", e);
                elements.batteryCapacity.value = DEFAULT_CAPACITY;
                elements.efficiency.value = DEFAULT_EFFICIENCY;
                updateAllLinkedValues();
                calculateAndUpdateResults();
                showSaveFeedback("설정 로드 실패. 기본값 사용.", "warning");
            }
        }

        // --- 초기화 및 전체 업데이트 ---
        function updateAllLinkedValues() {
             const capacity = getBatteryCapacity();

             isUpdating = true;

             if (elements.remainPercent.value !== '') {
                 elements.remainKWh.value = percentToKWh(parseFloat(elements.remainPercent.value));
             } else if (elements.remainKWh.value !== '') {
                 elements.remainPercent.value = kWhToPercent(parseFloat(elements.remainKWh.value));
             }

             if (elements.targetPercent.value !== '') {
                 elements.targetKWh.value = percentToKWh(parseFloat(elements.targetPercent.value));
             } else if (elements.targetKWh.value !== '') {
                 elements.targetPercent.value = kWhToPercent(parseFloat(elements.targetKWh.value));
             }

             isUpdating = false;
        }

        function resetForm() {
            elements.batteryCapacity.value = DEFAULT_CAPACITY;
            elements.remainPercent.value = "";
            elements.remainKWh.value = "";
            elements.targetPercent.value = "";
            elements.targetKWh.value = "";
            elements.chargeSpeed.value = "";
            elements.efficiency.value = DEFAULT_EFFICIENCY;
            Object.keys(elements).forEach(key => {
                if (key.endsWith("Error")) {
                    elements[key].innerText = "";
                     if (key === "startTimeError") {
                         elements[key].classList.remove("text-danger");
                         elements[key].classList.add("text-body-secondary");
                     }
                }
            });

            applyCurrentTime();
            updateAllLinkedValues();
            calculateAndUpdateResults();
            showSaveFeedback("입력값을 초기화했습니다.", "info");
        }

        function applyCurrentTime() {
            const now = new Date();
            elements.startTime.value = now.toLocaleTimeString('ko-KR', {
                hour: '2-digit',
                minute: '2-digit',
                hour12: false
            });
            calculateAndUpdateResults();
        }

        // --- 이벤트 리스너 ---
        elements.batteryCapacity.addEventListener('input', debounce(() => { updateAllLinkedValues(); calculateAndUpdateResults(); }, DEBOUNCE_DELAY));
        elements.remainPercent.addEventListener('input', debounce(handleRemainPercentChange, DEBOUNCE_DELAY));
        elements.remainKWh.addEventListener('input', debounce(handleRemainKWhChange, DEBOUNCE_DELAY));
        elements.targetPercent.addEventListener('input', debounce(handleTargetPercentChange, DEBOUNCE_DELAY));
        elements.targetKWh.addEventListener('input', debounce(handleTargetKWhChange, DEBOUNCE_DELAY));
        elements.chargeSpeed.addEventListener('input', calculateAndUpdateResultsDebounced);
        elements.efficiency.addEventListener('input', calculateAndUpdateResultsDebounced);
        elements.startTime.addEventListener('input', calculateAndUpdateResults);

        elements.applyCurrentTimeBtn.addEventListener('click', applyCurrentTime);
        elements.calculateBtn.addEventListener('click', calculateAndUpdateResults);
        elements.resetBtn.addEventListener('click', resetForm);
        elements.saveBatteryInfoBtn.addEventListener('click', saveBatteryInfo);
        elements.saveChargeSettingsBtn.addEventListener('click', saveChargeSettings);

        // Blur 이벤트: 값 보정 및 최종 유효성 검사
        elements.efficiency.addEventListener('blur', () => {
            const val = parseFloat(elements.efficiency.value);
            if (!isNaN(val)) {
                elements.efficiency.value = clamp(val, 1, 100).toFixed(1);
            } else if (elements.efficiency.value === '') {
                elements.efficiency.value = DEFAULT_EFFICIENCY;
            }
            validateInputs();
            calculateAndUpdateResultsDebounced();
        });

        elements.targetPercent.addEventListener('blur', () => {
             const t = parseFloat(elements.targetPercent.value);
             if (!isNaN(t)) {
                 elements.targetPercent.value = clamp(t, 0, 100).toFixed(2);
                 if (!isUpdating) handleTargetPercentChange();
             } else if (elements.targetPercent.value === '') {
                 if (!isUpdating) elements.targetKWh.value = '';
             }
             validateInputs();
             calculateAndUpdateResultsDebounced();
        });

         elements.targetKWh.addEventListener('blur', () => {
            const t = parseFloat(elements.targetKWh.value);
            const cap = getBatteryCapacity();
            if (!isNaN(t)) {
                 elements.targetKWh.value = clamp(t, 0, cap > 0 ? cap : Infinity).toFixed(2);
                 if (!isUpdating) handleTargetKWhChange();
             } else if (elements.targetKWh.value === '') {
                 if (!isUpdating) elements.targetPercent.value = '';
             }
             validateInputs();
             calculateAndUpdateResultsDebounced();
        });

        // 페이지 로드 시 초기화
        window.onload = () => {
            // 접근성 설정
            elements.batteryCapacity.setAttribute('aria-describedby', 'batteryCapacityError');
            elements.remainPercent.setAttribute('aria-describedby', 'remainError');
            elements.remainKWh.setAttribute('aria-describedby', 'remainError');
            elements.targetPercent.setAttribute('aria-describedby', 'targetError');
            elements.targetKWh.setAttribute('aria-describedby', 'targetError');
            elements.chargeSpeed.setAttribute('aria-describedby', 'chargeSpeedError');
            elements.efficiency.setAttribute('aria-describedby', 'efficiencyError');
            elements.startTime.setAttribute('aria-describedby', 'startTimeError');

            loadSettings();

            if (!elements.startTime.value) {
                applyCurrentTime();
            }
        };
    </script>
</body>
</html>
